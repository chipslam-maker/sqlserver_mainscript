# --- 設定區 ---
$paramsFilePath = "C:\YourPath\Project.params" # 指向你的 Project.params 路徑
$outputFile = "UpdateParams.sql"
$folderName = "TEST"        # Server B 上的資料夾名稱
$projectName = "YourProject" # Server B 上的專案名稱

# --- 執行邏輯 ---
[xml]$xml = Get-Content $paramsFilePath

# 處理 XML 命名空間
$ns = New-Object System.Xml.XmlNamespaceManager($xml.NameTable)
$ns.AddNamespace("SSIS", "www.microsoft.com/SqlServer/SSIS")

$sqlResults = @()
$sqlResults += "USE [SSISDB];`nGO`n"

# 取得所有參數節點
$parameters = Select-Xml -Xml $xml -XPath "//SSIS:Parameter" -Namespace $ns

foreach ($p in $parameters) {
    # 提取參數名稱
    $paramName = $p.Node.Attributes["SSIS:Name"].Value
    
    # 提取 Value 內容
    $valueNode = $p.Node.SelectSingleNode("SSIS:Properties/SSIS:Property[@SSIS:Name='Value']", $ns)
    $paramValue = $valueNode.InnerText
    
    # 檢查是否為 Sensitive (如果是，SQL 設為 NULL 提醒手動輸入)
    $sensitiveNode = $p.Node.SelectSingleNode("SSIS:Properties/SSIS:Property[@SSIS:Name='Sensitive']", $ns)
    
    if ($sensitiveNode.InnerText -eq "1") {
        $finalValue = "NULL -- <!! 需要手動填入加密資訊 !!>"
    } else {
        # 處理 SQL 字串中的單引號，防止注入錯誤
        $escapedValue = $paramValue.Replace("'", "''")
        $finalValue = "N'$escapedValue'"
    }

    # 組合 T-SQL
    $sql = "EXEC [catalog].[set_object_parameter_value] 
        @object_type = 20, 
        @folder_name = N'$folderName', 
        @project_name = N'$projectName', 
        @parameter_name = N'$paramName', 
        @parameter_value = $finalValue;
    GO"
    
    $sqlResults += $sql
}

# 輸出檔案
$sqlResults | Out-File $outputFile -Encoding utf8
Write-Host "成功！SQL 腳本已產生至: $outputFile" -ForegroundColor Green
